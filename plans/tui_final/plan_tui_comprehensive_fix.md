# Comprehensive TUI Fix Plan - Revised

## Core Architectural Principles (Reinforced)

*   **Validation is Deferred**: Validation of plate paths, backends, and other configuration details occurs at the `init` or `pre-compile` stage, not during the initial "Add Plate" dialog.
*   **Minimal "Add Plate" Dialog**: The "Add Plate" dialog should *only* collect the plate path. All other configuration is either defaulted or handled via a separate "Edit Plate Config" feature.
*   **Plate Status Symbols**: The TUI will use visual symbols (`?`, `-`, `✓`, `✗`) to indicate the initialization and compilation status of plates.
*   **Plates as Orchestrators**: Each plate corresponds to a `PipelineOrchestrator` instance, managing its own pipeline of steps.
*   **Dynamic UI from Static Reflection**: UI elements for configuration (e.g., function patterns, step parameters, global settings) are dynamically generated by inspecting Python objects and their metadata.
*   **Centralized `storage_registry`**: `OpenHCSTUI` creates the single `storage_registry` instance, which is then passed to components that need to create `FileManager` instances.

## Current State & Remaining Issues (Updated)

Based on the latest clarifications, here's an updated summary:

*   **Incomplete `async` Propagation**: Still a widespread issue. Many methods calling `self.state.notify` are not yet `async` or `await` the call.
*   **`PlateValidationService` Duplicate `close` method**: Still present.
*   **Incorrect `container` properties**: `PlateManagerPane` and `FunctionPatternEditor` still need their `container` properties corrected.
*   **"Add Plate" Dialog Scope**: The current `PlateDialogManager` implementation is too broad, asking for backend/microscope and performing validation. This needs to be simplified.
*   **Missing "Edit Plate Config" Feature**: A new feature is required to allow users to edit plate-specific configurations, overriding global defaults.
*   **Missing "Init" Button Logic**: The "Init" button in `PlateManagerPane` needs to trigger `PipelineOrchestrator.initialize()` and update plate status.
*   **Missing "Compile" Button Logic**: The "Compile" button needs to trigger `PipelineOrchestrator.compile_pipeline()`.
*   **Pipeline Editor Renaming**: `StepViewerPane` needs to be conceptually renamed to "Pipeline Editor" and its UI adjusted.
*   **Dual Step/Func Editor**: `FunctionPatternEditor` needs to be refactored to support two distinct views for "Step Settings" and "Func Pattern".
*   **Global Settings Editor**: A new dialog/pane for editing global settings is required.
*   **Microscope Type Handling**: The "Add Plate" dialog should not ask for microscope type. This is a configuration detail.
*   **Validation Timing**: All validation (path existence, backend, microscope) must occur during `init` or `pre-compile`, not during plate addition.

## Detailed Plan for TUI Fixes & New Features

This plan systematically addresses all identified issues and implements new features, ensuring architectural consistency and functional correctness.

### Phase 1: Refactor "Add Plate" Flow & Implement Plate Lifecycle

This phase focuses on simplifying the "Add Plate" dialog and implementing the core plate lifecycle (add, init, compile).

1.  **Simplify `PlateDialogManager` (`openhcs/tui/dialogs/plate_dialog_manager.py`)**:
    *   **Action**: Modify `_create_file_browser_dialog` (lines 214-303) to *only* include the `path_input` `TextArea`.
    *   **Action**: Remove all `backend_options`, `backend_selector`, `user_selected` logic, and related UI elements from `_create_file_browser_dialog`.
    *   **Action**: Modify `_handle_ok_button_press` (lines 428-498) to *remove all validation logic* (path non-empty, absolute, no URI schemes, exists, directory, backend selection). It should simply extract the `path` from `path_input.text`.
    *   **Action**: Modify `_dialog_ok` (lines 359-389) to accept only the `path` in its `result` dictionary, removing `backend`.
    *   **Action**: Update `show_add_plate_dialog` (lines 187-212) to reflect the simplified dialog result (only `path`).

2.  **Implement Plate Lifecycle in `PlateManagerPane` (`openhcs/tui/plate_manager_core.py`)**:
    *   **Action**: Modify `_handle_add_dialog_result` (lines 395-405) to receive only the `path`. It should then instantiate `PipelineOrchestrator` with this path and the `GlobalPipelineConfig` (obtained from `self.state.global_config` or `self.context.global_config`).
    *   **Action**: Update the plate data structure to include a `status` field (e.g., `?` for uninitialized, `-` for initialized, `✓` for compiled, `✗` for error).
    *   **Action**: Implement the "Init" button handler (`_on_init_plate`). This `async` method will:
        *   Get the selected plate's `PipelineOrchestrator` instance.
        *   Call `await orchestrator.initialize()`.
        *   Update the plate's status in `self.plates` to `-` (initialized) on success, or `✗` (error) on failure.
        *   Notify `self.state.notify('plate_status_changed', {'plate_id': plate['id'], 'status': new_status})`.
        *   Display errors in the status bar.
    *   **Action**: Implement the "Compile" button handler (`_on_compile_plate`). This `async` method will:
        *   Get the selected plate's `PipelineOrchestrator` instance.
        *   Call `await orchestrator.compile_pipeline()`.
        *   Update the plate's status in `self.plates` to `✓` (compiled) on success, or `✗` (error) on failure.
        *   Notify `self.state.notify('plate_status_changed', {'plate_id': plate['id'], 'status': new_status})`.
        *   Display errors in the status bar.
    *   **Action**: Update `_format_plate_list` to render the new status symbols (`?`, `-`, `✓`, `✗`).

3.  **Refine `PipelineOrchestrator.initialize()` (`openhcs/core/orchestrator/orchestrator.py`)**:
    *   **Action**: Ensure `initialize()` performs all necessary validation:
        *   Path existence and type (directory).
        *   Default backend application (from `GlobalPipelineConfig.vfs.default_intermediate_backend` and `default_materialization_backend`).
        *   Default microscope type application (from `GlobalPipelineConfig.microscope`).
        *   Any other initial setup required for the plate.
    *   **Action**: Ensure `initialize()` raises appropriate exceptions on validation failure.

### Phase 2: Complete `async` Propagation for `TUIState.notify`

This phase involves making all methods that call `self.state.notify` `async` and ensuring they `await` the call.

For each identified method:
*   Change its signature to `async def ...`.
*   Prepend `await` to each `self.state.notify(...)` call.

1.  **`openhcs/tui/step_viewer.py`**:
    *   `_load_steps_for_plate` (line 341)
    *   `_edit_step` (line 361)
    *   `_add_step` (line 403)
    *   `_move_step_up` (line 456)
    *   `_move_step_down` (line 491)

2.  **`openhcs/tui/action_menu_pane.py`**:
    *   `_create_buttons` (lines 116, 133, 150, 164, 171, 179, 185, 204, 214, 225, 236, 258, 273, 299, 308, 317, 343, 357, 452, 457) - These are nested within `lambda` functions that are handlers for `prompt_toolkit` buttons. The `lambda` functions themselves need to be `async` and `await` the `notify` call. This will require changing the `lambda` to an `async lambda` (if supported by the Python version, otherwise a nested `async def` function) and ensuring the `get_app().create_background_task` correctly handles the `async` nature.
    *   `_apply_and_save_global_config_settings` (line 777)
    *   `_persist_global_config_to_file` (line 655)

3.  **`openhcs/tui/plate_manager_core.py`**:
    *   `_handle_remove_dialog_result` (line 422)
    *   `_handle_validation_result` (line 448)
    *   `_handle_error` (line 463)
    *   `_select_plate` (line 508)
    *   `_update_plate_status` (line 534)

4.  **`openhcs/tui/status_bar.py`**:
    *   `_on_operation_status_changed` (line 363)
    *   `_on_error_event` (line 370)
    *   `_on_tui_log_level_changed` (line 387)
    *   `TUIStatusBarLogHandler.emit` (line 469) - This is a standard logging handler's `emit` method, which is synchronous. The `self.status_bar.add_log_entry` call within it needs to be wrapped in `get_app().create_background_task` if `add_log_entry` is `async`. (Checking `StatusBar.add_log_entry` in `status_bar.py`, it is `async`. So, the `emit` method needs to wrap the call in `create_background_task`.)

5.  **`openhcs/tui/menu_bar.py`**:
    *   `_on_new_pipeline` (line 912)
    *   `_on_open_pipeline` (line 918)
    *   `_on_save_pipeline` (lines 930, 938, 963, 973)
    *   `_on_save_pipeline_as` (line 984)
    *   `_on_exit` (line 988)
    *   `_on_add_step` (line 994)
    *   `_on_edit_step` (lines 1011, 1013, 1027)
    *   `_on_remove_step` (lines 1043, 1049, 1056, 1068, 1079)
    *   `_on_move_step_up` (line 1085)
    *   `_on_move_step_down` (line 1091)
    *   `_on_toggle_log_drawer` (line 1095)
    *   `_on_toggle_vim_mode` (line 1099)
    *   `_on_set_theme` (line 1108)
    *   `_on_pre_compile` (line 1112)
    *   `_on_compile` (line 1116)
    *   `_on_run` (line 1120)
    *   `_on_test` (lines 1131, 1135)
    *   `_on_settings` (line 1146)
    *   `_on_documentation` (line 1152)
    *   `_on_keyboard_shortcuts` (line 1158)
    *   `_on_about` (line 1164)

6.  **`openhcs/tui/function_pattern_editor.py`**:
    *   `_save_pattern` (line 933)
    *   `_cancel_editing` (line 940)

7.  **`openhcs/tui/tui_launcher.py`**:
    *   `__init__` (line 71) - This is a synchronous `__init__` method. The `self.state.notify` call needs to be wrapped in `get_app().create_background_task(...)`.
    *   `_handle_global_config_update` (line 112)
    *   `_on_plate_added` (lines 181, 184, 189)
    *   `_on_plate_removed` (lines 203, 209)
    *   `_on_plate_selected` (line 224)

### Phase 3: Address Remaining Architectural Inconsistencies

1.  **Duplicate `close` method in `openhcs/tui/services/plate_validation.py`**:
    *   Remove the non-async `close` method (lines 232-247). The `async close` method (lines 65-72) is the correct one.

2.  **Correct `container` property in `openhcs/tui/plate_manager_core.py`**:
    *   Modify the `@property container` to return `self.container` (which is assigned on line 163), not `self._container`.

3.  **Correct `container` property in `openhcs/tui/function_pattern_editor.py`**:
    *   Modify the `__init__` method to assign the `HSplit` to `self._container` (line 189).
    *   Modify the `@property container` to return `self._container` (line 198).

### Phase 4: New Features & UI Adjustments

This phase implements the new features and adjusts the UI as per the new mental model.

1.  **Implement Global Settings Editor**:
    *   **Action**: Create a new dialog/pane (e.g., `openhcs/tui/dialogs/global_settings_editor.py`) that dynamically generates UI elements for `GlobalPipelineConfig` fields (e.g., `num_workers`, `vfs.default_intermediate_backend`, `microscope`).
    *   **Action**: The UI should use dropdowns for enums (`Microscope`, `Backend`) and checkboxes for booleans.
    *   **Action**: Implement save/cancel logic to update the `GlobalPipelineConfig` instance and notify `TUIState`.

2.  **Implement "Edit Plate Config" Feature**:
    *   **Action**: Create a new dialog/pane (e.g., `openhcs/tui/dialogs/plate_config_editor.py`) similar to the Global Settings Editor, but for plate-specific overrides of `GlobalPipelineConfig` parameters.
    *   **Action**: This dialog will be launched from the "Edit" button in `PlateManagerPane`.

3.  **Implement Plate Reordering**:
    *   **Action**: Modify `openhcs/tui/plate_manager_core.py` to add "Move Up" and "Move Down" buttons in `_initialize_ui`.
    *   **Action**: Implement `_move_plate_up(self)` and `_move_plate_down(self)` `async` methods in `PlateManagerPane` to reorder `self.plates` and notify `self.state.notify('plates_reordered', ...)`.
    *   **Action**: Update `_create_key_bindings` in `PlateManagerPane` to include keybindings for plate reordering.

4.  **Refactor Dual Step/Func Editor (`openhcs/tui/function_pattern_editor.py`)**:
    *   **Action**: Refactor `FunctionPatternEditor` to support two toggleable views: "Step Settings" and "Func Pattern". This will involve creating separate UI components for each view and managing their visibility.
    *   **Action**: The "Step Settings" view will dynamically generate UI for `AbstractStep` parameters (e.g., `name`, `input_dir`, `output_dir`, `force_disk_output`, `variable_components`, `group_by`).
    *   **Action**: The "Func Pattern" view will be the existing function pattern editor.
    *   **Action**: Implement save/cancel logic for both views, updating the `FuncStep` object.

5.  **Rename Step Viewer to Pipeline Editor**:
    *   **Action**: Update the title of the `StepViewerPane`'s frame in `openhcs/tui/tui_architecture.py` to "Pipeline Editor".

### Phase 5: Final Verification

1.  **Run `python -m py_compile` on all TUI files**: To catch any new syntax errors introduced by the changes.
2.  **Generate all detailed definition matrices again**: To confirm all changes are reflected in the architectural reports and no new issues are introduced.
3.  **Review all generated reports**: Perform a final manual inspection for any remaining "smells" or inconsistencies. This includes checking for any remaining `RuntimeWarning: coroutine '...' was never awaited` patterns in the reports.

## Mermaid Diagram for Overall TUI Architecture (Conceptual)

```mermaid
graph TD
    A[OpenHCSTUILauncher] --> B(OpenHCSTUI)
    B --> C[TUIState]
    B --> D[PlateManagerPane]
    B --> E[StepViewerPane (Pipeline Editor)]
    B --> F[ActionMenuPane]
    B --> G[StatusBar]
    B --> H[MenuBar]
    B --> I[FunctionPatternEditor]

    C -- notifies (async) --> D
    C -- notifies (async) --> E
    C -- notifies (async) --> F
    C -- notifies (async) --> G
    C -- notifies (async) --> H
    C -- notifies (async) --> I

    D -- uses --> J[PlateDialogManager]
    D -- uses --> K[PlateValidationService]
    D -- uses --> N[PlateConfigEditor (New)]

    B -- creates --> L[StorageRegistry]
    L -- passed to --> D
    L -- passed to --> J
    L -- passed to --> K
    L -- passed to --> N
    L -- passed to --> M[PipelineOrchestrator]

    B -- uses --> O[GlobalSettingsEditor (New)]

    I -- edits --> P[FuncStep (AbstractStep params)]

    subgraph TUI Components
        D
        E
        F
        G
        H
        I
        J
        K
        N
        O
    end

    subgraph Core Services
        C
        L
        M
        P
    end